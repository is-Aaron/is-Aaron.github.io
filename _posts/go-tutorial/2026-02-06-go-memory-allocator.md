---
title: Go å†…å­˜ç®¡ç†ï¼šTCMalloc æ€æƒ³ä¸‹çš„å†…å­˜åˆ†é…å™¨
date: 2026-02-06 19:00:00 +0800
categories: [Go å…¥é—¨æ•™ç¨‹, åº•å±‚åŸç†, Go è¯­è¨€]
tags: [Go, å†…å­˜ç®¡ç†, TCMalloc, mcache, mcentral, mheap, mspan, é€ƒé€¸åˆ†æ, Runtime]
mermaid: true
---

> **æ ¸å¿ƒè§‚ç‚¹**ï¼šGo çš„å†…å­˜åˆ†é…å™¨å€Ÿé‰´äº† Google çš„ **TCMallocï¼ˆThread-Caching Mallocï¼‰** æ€æƒ³ï¼Œé‡‡ç”¨ **mcache â†’ mcentral â†’ mheap** ä¸‰çº§ç¼“å­˜æ¶æ„ã€‚æŒ‰å¯¹è±¡å¤§å°å°†åˆ†é…åˆ’åˆ†ä¸º**å¾®å¯¹è±¡ï¼ˆ<16Bï¼‰ã€å°å¯¹è±¡ï¼ˆ16B\~32KBï¼‰ã€å¤§å¯¹è±¡ï¼ˆ>32KBï¼‰**ä¸‰ç§ç­–ç•¥ï¼Œåœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥**æ— é”**å®Œæˆå†…å­˜åˆ†é…ã€‚é…åˆç¼–è¯‘æœŸçš„**é€ƒé€¸åˆ†æ**ï¼Œèƒ½è®©å¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ç›´æ¥åœ¨æ ˆä¸Šåˆ†é…ï¼Œä»æºå¤´å‡å°‘ GC å‹åŠ›ã€‚

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦ç²¾å¿ƒè®¾è®¡å†…å­˜åˆ†é…å™¨

### ç›´æ¥ç”¨ OS åˆ†é…å†…å­˜çš„ä»£ä»·

ç¨‹åºè¿è¡Œéœ€è¦å†…å­˜ï¼Œæœ€æœ´ç´ çš„æ–¹å¼æ˜¯æ¯æ¬¡éƒ½å‘æ“ä½œç³»ç»Ÿç”³è¯·â€”â€”è°ƒç”¨ `mmap` æˆ– `brk`ã€‚ä½†è¿™ä¼šå¸¦æ¥ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼š

| ç»´åº¦ | ç›´æ¥ç³»ç»Ÿè°ƒç”¨ | ç”¨æˆ·æ€åˆ†é…å™¨ |
| --- | --- | --- |
| **æ¯æ¬¡åˆ†é…çš„å¼€é”€** | ç³»ç»Ÿè°ƒç”¨ï¼Œæ•°ç™¾çº³ç§’åˆ°æ•°å¾®ç§’ | æŒ‡é’ˆç§»åŠ¨ï¼Œæ•°åçº³ç§’ |
| **æœ€å°åˆ†é…ç²’åº¦** | ä¸€ä¸ªå†…å­˜é¡µï¼ˆ4KB / 16KBï¼‰ | 8 å­—èŠ‚ |
| **å†…å­˜ç¢ç‰‡** | æ•´é¡µåˆ†é…ï¼Œå¤–éƒ¨ç¢ç‰‡ä¸¥é‡ | å¯ç²¾ç»†ç®¡ç† |
| **å¤šçº¿ç¨‹æ‰©å±•æ€§** | ä¾èµ–å†…æ ¸é” | å¯è®¾è®¡æ— é”/ä½ç«äº‰æ–¹æ¡ˆ |

å‡è®¾ä¸€ä¸ª Web æœåŠ¡æ¯ç§’å¤„ç† 10 ä¸‡æ¬¡è¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚äº§ç”Ÿ 50 æ¬¡å°å†…å­˜åˆ†é…â€”â€”å¦‚æœæ¯æ¬¡éƒ½èµ°ç³»ç»Ÿè°ƒç”¨ï¼Œä»…å†…å­˜åˆ†é…å°±ä¼šæ¶ˆè€—å¤§é‡ CPUã€‚

### ä¼ ç»Ÿ malloc çš„å¤šçº¿ç¨‹ç“¶é¢ˆ

C æ ‡å‡†åº“çš„ `malloc/free`ï¼ˆå¦‚ glibc çš„ ptmallocï¼‰è™½ç„¶æ˜¯ç”¨æˆ·æ€åˆ†é…å™¨ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä»æœ‰é—®é¢˜ï¼š

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿ malloc çš„é”ç«äº‰"
        direction LR
        T1["çº¿ç¨‹ 1"] -->|"åŠ é”"| Heap["å…¨å±€å †<br/>ğŸ”’ mutex"]
        T2["çº¿ç¨‹ 2"] -->|"ç­‰å¾…é”..."| Heap
        T3["çº¿ç¨‹ 3"] -->|"ç­‰å¾…é”..."| Heap
        T4["çº¿ç¨‹ 4"] -->|"ç­‰å¾…é”..."| Heap
    end

    style Heap fill:#ff8787
```

å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ†é…å†…å­˜æ—¶ï¼Œéƒ½éœ€è¦ç«äº‰åŒä¸€æŠŠé”ã€‚çº¿ç¨‹è¶Šå¤šï¼Œé”ç«äº‰è¶Šæ¿€çƒˆâ€”â€”è¿™åœ¨ Go è¿™ç§å¯èƒ½åŒæ—¶è¿è¡Œç™¾ä¸‡ Goroutine çš„è¿è¡Œæ—¶ä¸­æ˜¯ä¸å¯æ¥å—çš„ã€‚

### Go çš„ç‹¬ç‰¹æŒ‘æˆ˜

Go çš„å†…å­˜åˆ†é…å™¨è¿˜éœ€è¦åº”å¯¹ä¸€äº›è¯­è¨€ç‰¹æœ‰çš„æŒ‘æˆ˜ï¼š

1. **Goroutine æ•°é‡å·¨å¤§**ï¼šå¯èƒ½æœ‰æ•°åä¸‡ä¸ª Goroutine åŒæ—¶åˆ†é…å†…å­˜
2. **GC å‹å¥½**ï¼šåˆ†é…å™¨éœ€è¦ä¸ä¸‰è‰²æ ‡è®° GC æ·±åº¦åä½œï¼Œè·Ÿè¸ªæŒ‡é’ˆä¿¡æ¯
3. **æ ˆçš„åŠ¨æ€å¢é•¿**ï¼šGoroutine çš„æ ˆä¼šåŠ¨æ€æ‰©å±•å’Œæ”¶ç¼©ï¼Œä¹Ÿéœ€è¦åˆ†é…å™¨å‚ä¸
4. **ä¸è°ƒåº¦å™¨é›†æˆ**ï¼šåˆ†é…å™¨çš„ç¼“å­˜éœ€è¦å’Œ GMP è°ƒåº¦å™¨çš„ P ç»‘å®šï¼Œé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢æ—¶çš„ç¼“å­˜å¤±æ•ˆ

è¿™äº›æŒ‘æˆ˜å‚¬ç”Ÿäº† Go ç‹¬ç‰¹çš„å†…å­˜åˆ†é…å™¨è®¾è®¡ã€‚

## äºŒã€TCMallocï¼šGo å†…å­˜åˆ†é…çš„çµæ„Ÿä¹‹æº

Go çš„å†…å­˜åˆ†é…å™¨æ·±å— Google å¼€æºçš„ [TCMallocï¼ˆThread-Caching Mallocï¼‰](https://google.github.io/tcmalloc/) å½±å“ã€‚ç†è§£ TCMalloc çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ˜¯ç†è§£ Go åˆ†é…å™¨çš„å‰æã€‚

### TCMalloc çš„æ ¸å¿ƒæ€è·¯

TCMalloc çš„åå­—æ­ç¤ºäº†å®ƒçš„å…³é”®è®¾è®¡ï¼š**Thread-Caching**â€”â€”æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç¼“å­˜ã€‚

```mermaid
graph TB
    subgraph TCMalloc["TCMalloc æ¶æ„"]
        direction TB

        subgraph ThreadCaches["çº¿ç¨‹ç¼“å­˜ï¼ˆThread Cacheï¼‰"]
            TC1["çº¿ç¨‹ 1 çš„ç¼“å­˜<br/>8B: â—‹â†’â—‹â†’â—‹<br/>16B: â—‹â†’â—‹<br/>32B: â—‹â†’â—‹â†’â—‹â†’â—‹"]
            TC2["çº¿ç¨‹ 2 çš„ç¼“å­˜<br/>8B: â—‹â†’â—‹<br/>16B: â—‹â†’â—‹â†’â—‹<br/>32B: â—‹"]
        end

        subgraph CentralCache["ä¸­å¿ƒç¼“å­˜ï¼ˆCentral Cacheï¼‰"]
            CC["æ¯ä¸ª size class çš„ç©ºé—²åˆ—è¡¨<br/>ğŸ”’ ç»†ç²’åº¦é”"]
        end

        subgraph PageHeap["é¡µå †ï¼ˆPage Heapï¼‰"]
            PH["ç®¡ç† spanï¼ˆè¿ç»­çš„å†…å­˜é¡µï¼‰<br/>ğŸ”’ å…¨å±€é”"]
        end

        TC1 -->|"æœ¬åœ°ç¼“å­˜ç”¨å°½"| CC
        TC2 -->|"æœ¬åœ°ç¼“å­˜ç”¨å°½"| CC
        CC -->|"span ç”¨å®Œ"| PH
        PH -->|"å†…å­˜ä¸è¶³"| OS["æ“ä½œç³»ç»Ÿ (mmap)"]
    end

    style TC1 fill:#51cf66
    style TC2 fill:#51cf66
    style CC fill:#ffd43b
    style PH fill:#ff8787
```

**ä¸‰å±‚æ¶æ„çš„ç²¾å¦™ä¹‹å¤„**ï¼š

1. **çº¿ç¨‹ç¼“å­˜**ï¼šæ¯ä¸ªçº¿ç¨‹ç‹¬äº«ä¸€ä»½å°å¯¹è±¡ç¼“å­˜ï¼Œåˆ†é…/é‡Šæ”¾æ—¶**å®Œå…¨æ— é”**â€”â€”è¿™æ˜¯æœ€å¸¸è§çš„è·¯å¾„
2. **ä¸­å¿ƒç¼“å­˜**ï¼šå½“çº¿ç¨‹ç¼“å­˜ä¸å¤Ÿæˆ–å¤ªå¤šæ—¶ï¼Œä¸ä¸­å¿ƒç¼“å­˜äº¤æ¢â€”â€”ä½¿ç”¨**ç»†ç²’åº¦é”**ï¼ˆæ¯ä¸ª size class ä¸€æŠŠé”ï¼‰
3. **é¡µå †**ï¼šç®¡ç†å¤§å—å†…å­˜ï¼ˆspanï¼‰ï¼Œéœ€è¦æ—¶å‘ OS ç”³è¯·â€”â€”ä½¿ç”¨**å…¨å±€é”**ï¼Œä½†è®¿é—®é¢‘ç‡æœ€ä½

### Size Classï¼šæ¶ˆé™¤å¤–éƒ¨ç¢ç‰‡

TCMalloc çš„å¦ä¸€ä¸ªå…³é”®è®¾è®¡æ˜¯ **size classï¼ˆå¤§å°ç±»åˆ«ï¼‰**ï¼šå°†æ‰€æœ‰å¯èƒ½çš„åˆ†é…å¤§å°å½’ç±»åˆ°å›ºå®šçš„å‡ åç§è§„æ ¼ä¸­ã€‚

```
è¯·æ±‚å¤§å°    â†’ å®é™…åˆ†é… (size class)
1~8 å­—èŠ‚    â†’ 8 å­—èŠ‚
9~16 å­—èŠ‚   â†’ 16 å­—èŠ‚
17~24 å­—èŠ‚  â†’ 24 å­—èŠ‚
25~32 å­—èŠ‚  â†’ 32 å­—èŠ‚
...
```

ç”¨å°‘é‡**å†…éƒ¨ç¢ç‰‡**ï¼ˆåˆ†é…ç•¥å¤šäºè¯·æ±‚ï¼‰æ¢å–äº†**å‡ ä¹ä¸ºé›¶çš„å¤–éƒ¨ç¢ç‰‡**â€”â€”å› ä¸ºåŒä¸€ size class çš„å¯¹è±¡å¤§å°å®Œå…¨ç›¸åŒï¼Œå½’è¿˜åå¯ä»¥æ— ç¼å¤ç”¨ã€‚

### ä» TCMalloc åˆ° Go Allocator

Go çš„å†…å­˜åˆ†é…å™¨ç»§æ‰¿äº† TCMalloc çš„åˆ†å±‚ç¼“å­˜å’Œ size class æ€æƒ³ï¼Œä½†æ ¹æ®è‡ªèº«ç‰¹ç‚¹åšäº†é‡è¦æ”¹è¿›ï¼š

| ç‰¹æ€§ | TCMalloc | Go Allocator |
| --- | --- | --- |
| **ç¼“å­˜ç»‘å®š** | çº¿ç¨‹ç¼“å­˜ç»‘å®š OS çº¿ç¨‹ | mcache ç»‘å®š Pï¼ˆé€»è¾‘å¤„ç†å™¨ï¼‰ |
| **ç©ºé—²ç®¡ç†** | ç©ºé—²é“¾è¡¨ï¼ˆfree listï¼‰ | ä½å›¾ï¼ˆbitmapï¼‰åˆ†é… |
| **GC é›†æˆ** | æ— ï¼ˆæ‰‹åŠ¨ç®¡ç†ï¼‰ | ä¸ä¸‰è‰²æ ‡è®° GC æ·±åº¦åä½œ |
| **å¾®å¯¹è±¡ä¼˜åŒ–** | æ—  | tiny allocatorï¼ˆ<16B åˆå¹¶åˆ†é…ï¼‰ |
| **æŒ‡é’ˆæ„ŸçŸ¥** | ä¸åŒºåˆ† | åŒºåˆ† scan/noscanï¼ˆæœ‰æ— æŒ‡é’ˆï¼‰ |

## ä¸‰ã€Go å†…å­˜åˆ†é…å™¨çš„æ•´ä½“æ¶æ„

### å››å¤§æ ¸å¿ƒç»„ä»¶

Go çš„å†…å­˜åˆ†é…å™¨ç”±å››ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼Œå½¢æˆä¸€ä¸ªå±‚æ¬¡åˆ†æ˜çš„æ¶æ„ï¼š

```mermaid
graph TB
    subgraph "Go å†…å­˜åˆ†é…å™¨æ¶æ„"
        direction TB

        subgraph UserCode["ç”¨æˆ·ä»£ç "]
            Alloc["new(T) / make([]T, n) / &T{}"]
        end

        Alloc -->|"ç¼–è¯‘å™¨è½¬æ¢ä¸º"| Mallocgc["runtime.mallocgc()"]

        subgraph McacheLayer["ç¬¬ä¸€å±‚ï¼šmcacheï¼ˆper-P ç¼“å­˜ï¼‰"]
            direction LR
            MC1["P0.mcache<br/>æ¯ç§ spanClass<br/>æŒæœ‰ä¸€ä¸ªæ´»è·ƒ mspan"]
            MC2["P1.mcache"]
            MC3["P2.mcache"]
        end

        subgraph McentralLayer["ç¬¬äºŒå±‚ï¼šmcentralï¼ˆä¸­å¿ƒç¼“å­˜ï¼‰"]
            direction LR
            MCE1["mcentral[class 1]<br/>ğŸ”’"]
            MCE2["mcentral[class 2]<br/>ğŸ”’"]
            MCEN["mcentral[class N]<br/>ğŸ”’"]
        end

        subgraph MheapLayer["ç¬¬ä¸‰å±‚ï¼šmheapï¼ˆå †ç®¡ç†å™¨ï¼‰"]
            MH["mheap<br/>é¡µåˆ†é…å™¨ + arena ç®¡ç†<br/>ğŸ”’ å…¨å±€é”"]
        end

        subgraph OSLayer["æ“ä½œç³»ç»Ÿ"]
            MMAP["mmap / VirtualAlloc"]
        end

        Mallocgc --> McacheLayer
        McacheLayer -->|"mspan ç”¨å°½"| McentralLayer
        McentralLayer -->|"æ— å¯ç”¨ mspan"| MheapLayer
        MheapLayer -->|"è™šæ‹Ÿå†…å­˜ä¸è¶³"| OSLayer
    end

    style MC1 fill:#51cf66
    style MC2 fill:#51cf66
    style MC3 fill:#51cf66
    style MCE1 fill:#ffd43b
    style MCE2 fill:#ffd43b
    style MCEN fill:#ffd43b
    style MH fill:#ff8787
```

**ä»ä¸Šåˆ°ä¸‹ï¼Œè®¿é—®é¢‘ç‡é€’å‡ã€é”ç²’åº¦é€’å¢**â€”â€”ç»å¤§å¤šæ•°åˆ†é…åœ¨ç¬¬ä¸€å±‚ mcache ä¸­å®Œæˆï¼Œä¸éœ€è¦ä»»ä½•é”ã€‚

### mcache ä¸ºä»€ä¹ˆç»‘å®š P è€Œä¸æ˜¯ M

åœ¨ Go 1.0 æ—¶ä»£ï¼Œmcache æ˜¯ç»‘å®šåœ¨ Mï¼ˆOS çº¿ç¨‹ï¼‰ä¸Šçš„ã€‚è¿™å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼šå½“ M å› ç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œå®ƒæŒæœ‰çš„ mcache ä¹Ÿéšä¹‹é—²ç½®â€”â€”ä½†å…¶ä»– M æ— æ³•ä½¿ç”¨è¿™ä¸ª mcacheã€‚

Go 1.1 å¼•å…¥ Pï¼ˆé€»è¾‘å¤„ç†å™¨ï¼‰åï¼Œmcache è¢«è½¬ç§»åˆ°äº† P ä¸Šã€‚è¿™ä¸ GMP è°ƒåº¦å™¨å®Œç¾é…åˆï¼š

```mermaid
graph LR
    subgraph "mcache ç»‘å®š Mï¼ˆæ—§è®¾è®¡ï¼‰"
        M1_old["M1 (é˜»å¡ä¸­)<br/>mcache âŒ é—²ç½®"]
        M2_old["M2 (è¿è¡Œä¸­)<br/>mcache âœ“"]
        M3_old["M3 (æ–°å»º)<br/>æ—  mcache âŒ"]
    end

    subgraph "mcache ç»‘å®š Pï¼ˆGo 1.1+ï¼‰"
        M1_new["M1 (é˜»å¡)"]
        P_new["P<br/>mcache âœ“"]
        M2_new["M2 (æ¥ç®¡ P)"]

        M1_new -.->|"M1 é˜»å¡<br/>é‡Šæ”¾ P"| P_new
        P_new -->|"P è¢«ç§»äº¤"| M2_new
    end

    style M1_old fill:#ff8787
    style M3_old fill:#ff8787
    style P_new fill:#51cf66
    style M2_new fill:#51cf66
```

å½“ M1 è¿›å…¥é˜»å¡ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒPï¼ˆè¿åŒå®ƒçš„ mcacheï¼‰è¢«ç§»äº¤ç»™ M2â€”â€”mcache å§‹ç»ˆè·Ÿç€"æ­£åœ¨å·¥ä½œçš„æ‰§è¡Œè€…"ï¼Œä¸ä¼šè¢«æµªè´¹ã€‚è¿™ä¸ GMP è°ƒåº¦å™¨çš„ Hand-off æœºåˆ¶ä¸€è„‰ç›¸æ‰¿ã€‚

### æ‰€æœ‰å †åˆ†é…çš„å…¥å£ï¼šmallocgc

Go ä¸­æ‰€æœ‰çš„å †å†…å­˜åˆ†é…æœ€ç»ˆéƒ½ä¼šèµ°åˆ° `runtime.mallocgc` å‡½æ•°ã€‚ç¼–è¯‘å™¨ä¼šå°† `new`ã€`make`ã€å­—é¢é‡å–åœ°å€ç­‰æ“ä½œè½¬æ¢ä¸º `mallocgc` è°ƒç”¨ï¼š

```go
// runtime/malloc.goï¼ˆç®€åŒ–éª¨æ¶ï¼‰
func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
    // è·å–å½“å‰ P çš„ mcache
    mp := acquirem()
    c := getMCache(mp)

    var span *mspan
    var x unsafe.Pointer

    // æ ¹æ®å¯¹è±¡å¤§å°é€‰æ‹©åˆ†é…ç­–ç•¥
    noscan := typ == nil || !typ.Pointers()

    if size <= maxSmallSize { // maxSmallSize = 32768 (32KB)
        if noscan && size < maxTinySize { // maxTinySize = 16
            // â‘  å¾®å¯¹è±¡åˆ†é…ï¼ˆ< 16 å­—èŠ‚ï¼Œæ— æŒ‡é’ˆï¼‰
            // ...
        } else {
            // â‘¡ å°å¯¹è±¡åˆ†é…ï¼ˆ16 å­—èŠ‚ ~ 32KBï¼‰
            // ...
        }
    } else {
        // â‘¢ å¤§å¯¹è±¡åˆ†é…ï¼ˆ> 32KBï¼‰
        // ...
    }

    // ... GC ç›¸å…³å¤„ç†ï¼ˆå†™å±éšœã€è§¦å‘ GC æ£€æŸ¥ç­‰ï¼‰
    return x
}
```

ä¸‰æ¡åˆ†æ”¯å¯¹åº”ä¸‰ç§æˆªç„¶ä¸åŒçš„åˆ†é…ç­–ç•¥ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬å…­èŠ‚è¯¦ç»†å±•å¼€ã€‚

## å››ã€mspanï¼šå†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒ

### ä»€ä¹ˆæ˜¯ mspan

mspan æ˜¯ Go å†…å­˜åˆ†é…å™¨ä¸­æœ€åŸºç¡€çš„æ¦‚å¿µâ€”â€”å®ƒæ˜¯ä¸€å—**è¿ç»­å†…å­˜é¡µ**çš„å°è£…ï¼Œè¢«åˆ’åˆ†ä¸ºç­‰å¤§çš„**å¯¹è±¡æ§½ï¼ˆslotï¼‰**ã€‚å¯ä»¥æŠŠ mspan ç†è§£ä¸º"ä¸€ç›’æ ‡å‡†åŒ–çš„æ ¼å­"ï¼š

```mermaid
graph TB
    subgraph "ä¸€ä¸ª mspanï¼ˆclass 5: 48 å­—èŠ‚ï¼‰"
        direction LR
        Header["mspan å…ƒæ•°æ®<br/>startAddr, npages<br/>spanClass, freeindex<br/>allocBits, gcmarkBits"]

        subgraph Pages["8192 å­—èŠ‚ = 1 é¡µ"]
            S0["slot 0<br/>48B âœ“"]
            S1["slot 1<br/>48B âœ—"]
            S2["slot 2<br/>48B âœ“"]
            S3["slot 3<br/>48B âœ“"]
            Dots["..."]
            S169["slot 169<br/>48B âœ—"]
        end

        subgraph Bitmap["allocBitsï¼ˆåˆ†é…ä½å›¾ï¼‰"]
            B["1 0 1 1 ... 0<br/>1=å·²åˆ†é… 0=ç©ºé—²"]
        end
    end

    style S0 fill:#ff8787
    style S1 fill:#51cf66
    style S2 fill:#ff8787
    style S3 fill:#ff8787
    style S169 fill:#51cf66
```

æ¯ä¸ª mspan å¯¹åº” Go è¿è¡Œæ—¶ä¸­çš„ `runtime.mspan` ç»“æ„ä½“ï¼š

```go
// runtime/mheap.goï¼ˆç®€åŒ–ï¼‰
type mspan struct {
    next     *mspan     // é“¾è¡¨ï¼šç”¨äº mcentral çš„ span ç®¡ç†
    prev     *mspan

    startAddr uintptr   // èµ·å§‹åœ°å€
    npages    uintptr   // å ç”¨çš„é¡µæ•°ï¼ˆGo é¡µ = 8KBï¼‰

    freeindex uintptr   // ä»æ­¤ä½ç½®å¼€å§‹æœç´¢ç©ºé—² slot
    nelems    uintptr   // slot æ€»æ•°

    allocBits  *gcBits  // åˆ†é…ä½å›¾ï¼šæ ‡è®°å“ªäº› slot å·²è¢«å ç”¨
    gcmarkBits *gcBits  // GC æ ‡è®°ä½å›¾ï¼šæ ‡è®°å“ªäº› slot è¢« GC æ ‡è®°ä¸ºå­˜æ´»

    spanclass spanClass // å¤§å°ç±»åˆ« + æ˜¯å¦åŒ…å«æŒ‡é’ˆ
    // ...
}
```

### Size Class ä¸ Span Class

Go å®šä¹‰äº† **68 ç§ size class**ï¼ˆç¼–å· 0\~67ï¼‰ï¼Œæ¶µç›–äº†ä» 8 å­—èŠ‚åˆ° 32KB çš„æ‰€æœ‰å°å¯¹è±¡è§„æ ¼ã€‚class 0 æ˜¯ç‰¹æ®Šçš„ï¼Œä¸“ç”¨äºå¤§å¯¹è±¡ï¼ˆ>32KBï¼‰ã€‚

ä»¥ä¸‹æ˜¯éƒ¨åˆ†ä»£è¡¨æ€§ size classï¼ˆæ‘˜è‡ª `runtime/sizeclasses.go`ï¼‰ï¼š

| class | å¯¹è±¡å¤§å° | span å¤§å° | æ¯ span å¯¹è±¡æ•° | æœ€å¤§æµªè´¹ç‡ |
| --- | --- | --- | --- | --- |
| 1 | 8 B | 8 KB | 1024 | 87.50% |
| 2 | 16 B | 8 KB | 512 | 43.75% |
| 4 | 32 B | 8 KB | 256 | 21.88% |
| 10 | 128 B | 8 KB | 64 | 11.72% |
| 18 | 256 B | 8 KB | 32 | 5.86% |
| 32 | 1 KB | 8 KB | 8 | 12.40% |
| 44 | 4 KB | 8 KB | 2 | 15.60% |
| 51 | 8 KB | 8 KB | 1 | 15.61% |
| 59 | 16 KB | 16 KB | 1 | 12.49% |
| 67 | 32 KB | 32 KB | 1 | 12.50% |

**è®¾è®¡è¦ç‚¹**ï¼š

- ç›¸é‚» size class ä¹‹é—´çš„å¢é•¿å¹…åº¦æ§åˆ¶åœ¨çº¦ **12.5%**ï¼ˆå³ 1/8ï¼‰ï¼Œè¿™ä¿è¯äº†å¯¹äºä»»æ„å¤§å°çš„è¯·æ±‚ï¼Œ**å†…éƒ¨ç¢ç‰‡ä¸è¶…è¿‡ \~12.5%**
- span å¤§å°æ˜¯ Go é¡µï¼ˆ8KBï¼‰çš„æ•´æ•°å€ï¼Œæœ€å¤§åˆ©ç”¨é¡µé¢ç©ºé—´
- è¾ƒå¤§çš„ size class æ¯ä¸ª span åªå« 1\~2 ä¸ªå¯¹è±¡ï¼Œå‡å°‘ span å†…çš„æµªè´¹

### scan ä¸ noscanï¼šè®© GC å°‘å¹²æ´»

Go çš„åˆ†é…å™¨ä¼šåŒºåˆ†**æ˜¯å¦åŒ…å«æŒ‡é’ˆ**çš„å¯¹è±¡ï¼š

```go
// spanClass ç¼–ç äº† size class å’Œ noscan æ ‡è®°
type spanClass uint8

// spanClass = sizeClass << 1 | noscan
// ä¾‹å¦‚ï¼šsizeClass=5, noscan=1 â†’ spanClass = 5*2+1 = 11
```

å› æ­¤å…±æœ‰ 68 Ã— 2 = **136 ç§ span class**ã€‚å°† scanï¼ˆå«æŒ‡é’ˆï¼‰å’Œ noscanï¼ˆæ— æŒ‡é’ˆï¼‰çš„å¯¹è±¡åˆ†å¼€å­˜æ”¾ï¼ŒGC æ‰«ææ—¶å¯ä»¥**è·³è¿‡æ•´ä¸ª noscan span**â€”â€”é‡Œé¢æ²¡æœ‰ä»»ä½•æŒ‡é’ˆï¼Œæ— éœ€é€ä¸ªæ‰«æå¯¹è±¡ã€‚

```mermaid
graph LR
    subgraph "scan span (spanClass å¶æ•°)"
        SS["å¯¹è±¡å«æŒ‡é’ˆ<br/>GC éœ€è¦æ‰«ææ¯ä¸ªå¯¹è±¡<br/>å¯»æ‰¾å †å¼•ç”¨"]
    end

    subgraph "noscan span (spanClass å¥‡æ•°)"
        NS["å¯¹è±¡æ— æŒ‡é’ˆ<br/>GC ç›´æ¥è·³è¿‡æ•´ä¸ª span<br/>å¤§å¹…å‡å°‘æ‰«æé‡"]
    end

    style SS fill:#ffd43b
    style NS fill:#51cf66
```

è¿™å¯¹ GC æ€§èƒ½çš„å½±å“æ˜¯å·¨å¤§çš„â€”â€”åœ¨å…¸å‹çš„ Go ç¨‹åºä¸­ï¼Œå¤§é‡å­—ç¬¦ä¸²çš„åº•å±‚å­—èŠ‚æ•°ç»„ã€æ•°å€¼ç±»å‹çš„ slice ç­‰éƒ½æ˜¯ noscan å¯¹è±¡ã€‚

## äº”ã€ä¸‰çº§ç¼“å­˜è¯¦è§£ï¼šmcache â†’ mcentral â†’ mheap

### ç¬¬ä¸€å±‚ï¼šmcacheâ€”â€”æ¯ä¸ª P çš„æœ¬åœ°ç¼“å­˜

mcache æ˜¯è·ç¦»ç”¨æˆ·ä»£ç æœ€è¿‘çš„ç¼“å­˜å±‚ï¼Œæ¯ä¸ª P æŒæœ‰ä¸€ä¸ª mcache å®ä¾‹ï¼š

```go
// runtime/mcache.goï¼ˆç®€åŒ–ï¼‰
type mcache struct {
    // ---- Tiny allocatorï¼ˆå¾®å¯¹è±¡åˆ†é…å™¨ï¼‰----
    tiny       uintptr // å½“å‰ tiny å—çš„åœ°å€
    tinyoffset uintptr // å½“å‰ tiny å—çš„åç§»
    tinyAllocs uintptr // tiny åˆ†é…è®¡æ•°

    // ---- æ¯ç§ span class ä¸€ä¸ªæ´»è·ƒ mspan ----
    alloc [136]*mspan // alloc[spanClass] â†’ å½“å‰æ­£åœ¨ä½¿ç”¨çš„ mspan
}
```

**mcache çš„å·¥ä½œåŸç†**ï¼š

```mermaid
graph TB
    subgraph "mcache å†…éƒ¨ç»“æ„"
        direction TB

        Tiny["tiny allocator<br/>16B å— â†’ åˆå¹¶å¾®å¯¹è±¡"]

        subgraph AllocArray["alloc[136] æ•°ç»„"]
            A0["[0] â†’ mspan (class 0, scan)"]
            A1["[1] â†’ mspan (class 0, noscan)"]
            A2["[2] â†’ mspan (class 1, scan)"]
            A3["[3] â†’ mspan (class 1, noscan)"]
            Dots["..."]
            A135["[135] â†’ mspan (class 67, noscan)"]
        end
    end

    subgraph "åˆ†é…æµç¨‹"
        Req["è¯·æ±‚åˆ†é… 40 å­—èŠ‚<br/>å«æŒ‡é’ˆ"]
        Req -->|"1. ç¡®å®š sizeClass=5 (48B)<br/>2. noscan=false<br/>3. spanClass=10"| GetSpan["è·å– alloc[10]"]
        GetSpan -->|"4. åœ¨ mspan ä¸­<br/>æ‰¾ç©ºé—² slot"| Result["è¿”å› slot åœ°å€"]
    end

    style Tiny fill:#e7f5ff
    style Result fill:#51cf66
```

**å…³é”®ä¼˜åŠ¿**ï¼šmcache çš„æ‰€æœ‰æ“ä½œéƒ½åœ¨**å½“å‰ P ä¸Šå®Œæˆ**ï¼Œæ— éœ€åŠ é”ã€‚å› ä¸ºåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª M ç»‘å®šä¸€ä¸ª Pï¼Œä¸ä¼šå‡ºç°å¹¶å‘è®¿é—®ã€‚

### ç¬¬äºŒå±‚ï¼šmcentralâ€”â€”ä¸­å¿ƒç¼“å­˜

å½“ mcache ä¸­æŸä¸ª span class çš„ mspan å¯¹è±¡å…¨éƒ¨ç”¨å®Œæ—¶ï¼Œéœ€è¦å‘ mcentral è·å–ä¸€ä¸ªæ–°çš„ mspanã€‚æ¯ç§ span class å¯¹åº”ä¸€ä¸ª mcentral å®ä¾‹ï¼š

```go
// runtime/mcentral.goï¼ˆç®€åŒ–ï¼‰
type mcentral struct {
    spanclass spanClass

    // Go 1.16+ ä½¿ç”¨ spanSet æ›¿ä»£äº†ä¹‹å‰çš„é“¾è¡¨
    partial [2]spanSet // æœ‰ç©ºé—² slot çš„ mspan é›†åˆ
    full    [2]spanSet // æ²¡æœ‰ç©ºé—² slot çš„ mspan é›†åˆ
}
```

`partial` å’Œ `full` å„æœ‰ä¸¤ä¸ªé›†åˆï¼ˆ`[2]`ï¼‰ï¼Œåˆ†åˆ«å¯¹åº” **å·²æ¸…æ‰«** å’Œ **æœªæ¸…æ‰«** çš„ spanâ€”â€”è¿™æ˜¯ä¸ºäº†é…åˆ GC çš„æ¸…æ‰«ï¼ˆsweepï¼‰é˜¶æ®µã€‚

```mermaid
graph TB
    subgraph "mcentral çš„å·¥ä½œæµç¨‹"
        direction TB

        MCReq["mcache è¯·æ±‚æ–° mspan"]

        MCReq --> Step1["â‘  ä» partial.swept å–"]
        Step1 -->|"æœ‰"| Return["è¿”å›ç»™ mcache"]

        Step1 -->|"æ²¡æœ‰"| Step2["â‘¡ ä» partial.unswept å–<br/>ï¼ˆå…ˆæ¸…æ‰«ï¼‰"]
        Step2 -->|"æœ‰"| Return

        Step2 -->|"æ²¡æœ‰"| Step3["â‘¢ ä» full.unswept å–<br/>ï¼ˆæ¸…æ‰«åå¯èƒ½äº§ç”Ÿç©ºé—² slotï¼‰"]
        Step3 -->|"æœ‰"| Return

        Step3 -->|"æ²¡æœ‰"| Step4["â‘£ å‘ mheap ç”³è¯·æ–°é¡µ<br/>åˆ›å»ºæ–° mspan"]
        Step4 --> Return
    end

    subgraph "mcache å½’è¿˜æ—§ mspan"
        Old["æ—§ mspanï¼ˆå·²æ»¡ï¼‰"]
        Old --> Full["æ”¾å…¥ mcentral.full"]
    end

    style Return fill:#51cf66
    style Step4 fill:#ff8787
```

**åŠ é”ç²’åº¦**ï¼šmcentral çš„æ“ä½œéœ€è¦åŠ é”ï¼Œä½†æ¯ä¸ª span class æœ‰ç‹¬ç«‹çš„ mcentralâ€”â€”å…± 136 ä¸ªã€‚è¿™æ¯”ä¸€æŠŠå…¨å±€é”çš„ç«äº‰å°å¾—å¤šã€‚

### ç¬¬ä¸‰å±‚ï¼šmheapâ€”â€”å…¨å±€å †ç®¡ç†å™¨

mheap æ˜¯å†…å­˜åˆ†é…å™¨çš„"æœ€åä¸€é“é˜²çº¿"ï¼Œç®¡ç†ç€æ•´ä¸ª Go å †çš„å†…å­˜ã€‚å®ƒè´Ÿè´£ä»¥**é¡µ**ï¼ˆ8KBï¼‰ä¸ºå•ä½åˆ†é…å†…å­˜ï¼Œåˆ›å»ºæ–°çš„ mspanï¼š

```go
// runtime/mheap.goï¼ˆç®€åŒ–ï¼‰
type mheap struct {
    lock mutex // å…¨å±€é”

    pages pageAlloc // é¡µåˆ†é…å™¨ï¼ˆåŸºæ•°æ ‘ï¼‰

    allspans []*mspan // æ‰€æœ‰åˆ›å»ºè¿‡çš„ mspan

    // æ‰€æœ‰ mcentralï¼ŒæŒ‰ span class ç»„ç»‡
    central [136]struct {
        mcentral mcentral
        pad      [64]byte // ç¼“å­˜è¡Œå¡«å……ï¼Œé¿å… false sharing
    }

    // arena ç®¡ç†
    arenas [1 << arenaL1Bits]*[1 << arenaL2Bits]*heapArena
    // ...
}
```

**mheap çš„æ ¸å¿ƒèŒè´£**ï¼š

1. **é¡µåˆ†é…**ï¼šå½“ mcentral éœ€è¦æ–° mspan æ—¶ï¼Œä»é¡µåˆ†é…å™¨ä¸­æ‰¾åˆ°åˆé€‚å¤§å°çš„è¿ç»­ç©ºé—²é¡µ
2. **å¤§å¯¹è±¡åˆ†é…**ï¼šå¤§äº 32KB çš„å¯¹è±¡ç›´æ¥ä» mheap åˆ†é…ï¼Œç»•è¿‡ mcache å’Œ mcentral
3. **arena ç®¡ç†**ï¼šç®¡ç†è™šæ‹Ÿå†…å­˜çš„ arena ç»„ç»‡ç»“æ„
4. **ä¸ GC åä½œ**ï¼šç»´æŠ¤ span åˆ—è¡¨ï¼Œé…åˆ GC è¿›è¡Œæ ‡è®°å’Œæ¸…æ‰«

### ä¸‰çº§ç¼“å­˜çš„å®Œæ•´æµç¨‹

ä»¥åˆ†é…ä¸€ä¸ª **40 å­—èŠ‚ã€å«æŒ‡é’ˆ**çš„å¯¹è±¡ä¸ºä¾‹ï¼Œå®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š

```mermaid
sequenceDiagram
    participant Code as ç”¨æˆ·ä»£ç 
    participant MC as mcache (P æœ¬åœ°)
    participant MCE as mcentral (class 10)
    participant MH as mheap (å…¨å±€)
    participant OS as æ“ä½œç³»ç»Ÿ

    Code->>MC: mallocgc(40, typ, true)<br/>sizeClass=5, spanClass=10

    Note over MC: æŸ¥æ‰¾ alloc[10] çš„ mspan

    alt mspan æœ‰ç©ºé—² slot
        MC->>Code: è¿”å› slot åœ°å€ âœ“ï¼ˆæ— é”ï¼‰
    else mspan å·²æ»¡
        MC->>MCE: è¯·æ±‚æ–°çš„ mspanï¼ˆåŠ é”ï¼‰
        alt mcentral æœ‰å¯ç”¨ mspan
            MCE->>MC: è¿”å› mspan
            MC->>Code: ä»æ–° mspan åˆ†é… slot
        else mcentral æ— å¯ç”¨ mspan
            MCE->>MH: è¯·æ±‚åˆ†é…é¡µï¼ˆå…¨å±€é”ï¼‰
            alt mheap æœ‰ç©ºé—²é¡µ
                MH->>MCE: åˆ†é…é¡µï¼Œåˆ›å»ºæ–° mspan
            else mheap æ— ç©ºé—²é¡µ
                MH->>OS: mmap ç”³è¯·æ–°å†…å­˜
                OS->>MH: è¿”å›è™šæ‹Ÿå†…å­˜
                MH->>MCE: åˆ†é…é¡µï¼Œåˆ›å»ºæ–° mspan
            end
            MCE->>MC: è¿”å›æ–° mspan
            MC->>Code: ä»æ–° mspan åˆ†é… slot
        end
    end
```

**æ ¸å¿ƒæ•°æ®**ï¼šæ ¹æ® Go å›¢é˜Ÿçš„ç»Ÿè®¡ï¼Œçº¦ **85% ä»¥ä¸Š**çš„å°å¯¹è±¡åˆ†é…åœ¨ mcache å±‚å°±èƒ½å®Œæˆâ€”â€”è¿™æ„å‘³ç€ç»å¤§å¤šæ•°åˆ†é…æ˜¯**æ— é”**çš„ã€‚

## å…­ã€ä¸‰ç§å¯¹è±¡çš„åˆ†é…ç­–ç•¥

### å¾®å¯¹è±¡ï¼ˆ<16 å­—èŠ‚ï¼Œæ— æŒ‡é’ˆï¼‰ï¼šTiny Allocator

å¯¹äºæå°çš„ã€ä¸å«æŒ‡é’ˆçš„å¯¹è±¡ï¼ˆå¦‚çŸ­å­—ç¬¦ä¸²çš„åº•å±‚å­—èŠ‚ã€å°æ•´æ•°ç­‰ï¼‰ï¼ŒGo ä½¿ç”¨äº†ä¸€ä¸ªå·§å¦™çš„ **tiny allocator**â€”â€”å°†å¤šä¸ªå¾®å¯¹è±¡**æ‰“åŒ…**è¿›åŒä¸€ä¸ª 16 å­—èŠ‚çš„å—ä¸­ã€‚

```mermaid
graph TB
    subgraph "Tiny Allocator çš„å·¥ä½œæ–¹å¼"
        direction TB

        subgraph Before["åˆ†é… 3 ä¸ªå¾®å¯¹è±¡å‰"]
            Block1["tiny å— (16B)<br/>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br/>â”‚ ç©ºé—² 16B &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; â”‚<br/>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br/>tinyoffset = 0"]
        end

        subgraph After["ä¾æ¬¡åˆ†é…å"]
            Block2["tiny å— (16B)<br/>â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”<br/>â”‚ 3B â”‚ &nbsp;5B &nbsp; â”‚ &nbsp;7B &nbsp; â”‚ 1B å‰©ä½™<br/>â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜<br/>tinyoffset = 15"]
        end

        Before -->|"alloc(3B), alloc(5B), alloc(7B)"| After
    end

    style Block1 fill:#51cf66
    style Block2 fill:#ffd43b
```

```go
// runtime/malloc.goï¼ˆç®€åŒ–ï¼‰
// Tiny allocator è·¯å¾„
off := c.tinyoffset
// æŒ‰éœ€å¯¹é½
if size&7 == 0 {
    off = alignUp(off, 8)
} else if size&3 == 0 {
    off = alignUp(off, 4)
} else if size&1 == 0 {
    off = alignUp(off, 2)
}

if off+size <= maxTinySize { // è¿˜èƒ½å¡è¿›å½“å‰ tiny å—
    x = unsafe.Pointer(c.tiny + off)
    c.tinyoffset = off + size
    c.tinyAllocs++
    return x
}
// å½“å‰ tiny å—æ”¾ä¸ä¸‹äº† â†’ ä» mcache åˆ†é…æ–°çš„ 16B slot ä½œä¸º tiny å—
```

**ä¸ºä»€ä¹ˆ tiny allocator åªç”¨äºæ— æŒ‡é’ˆå¯¹è±¡ï¼Ÿ**

å› ä¸º GC ä»¥å¯¹è±¡ä¸ºå•ä½è¿›è¡Œæ ‡è®°ã€‚å¦‚æœ tiny å—ä¸­æ··åˆäº†æœ‰æŒ‡é’ˆå’Œæ— æŒ‡é’ˆçš„å¯¹è±¡ï¼ŒGC å°±æ— æ³•æ­£ç¡®è¿½è¸ªå¼•ç”¨å…³ç³»ã€‚æ— æŒ‡é’ˆå¯¹è±¡ä¸å½±å“ GC çš„æ ‡è®°æ‰«æï¼Œå¯ä»¥å®‰å…¨åœ°åˆå¹¶ã€‚

**æ•ˆæœæ˜¾è‘—**ï¼šGo å®˜æ–¹æ•°æ®è¡¨æ˜ï¼Œtiny allocator å¯ä»¥å°†æŸäº›å·¥ä½œè´Ÿè½½çš„å†…å­˜åˆ†é…æ¬¡æ•°å‡å°‘çº¦ **12%**ã€‚

### å°å¯¹è±¡ï¼ˆ16 å­—èŠ‚ ~ 32KBï¼‰ï¼šSize Class åˆ†é…

è¿™æ˜¯æœ€å¸¸è§çš„åˆ†é…è·¯å¾„ï¼Œä½¿ç”¨å®Œæ•´çš„ä¸‰çº§ç¼“å­˜æœºåˆ¶ï¼š

```go
// runtime/malloc.goï¼ˆç®€åŒ–ï¼‰
// å°å¯¹è±¡åˆ†é…è·¯å¾„
var sizeclass uint8
if size <= smallSizeMax-8 { // smallSizeMax = 1024
    sizeclass = size_to_class8[divRoundUp(size, smallSizeDiv)]
} else {
    sizeclass = size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]
}
spc := makeSpanClass(sizeclass, noscan)

span = c.alloc[spc]         // ä» mcache è·å–å¯¹åº”çš„ mspan
v, _ := nextFreeFast(span)   // å¿«é€Ÿè·¯å¾„ï¼šæŸ¥æ‰¾ç©ºé—² slot
if v == 0 {
    v, span = c.nextFree(spc) // æ…¢é€Ÿè·¯å¾„ï¼šå¯èƒ½è§¦å‘ mcentral/mheap
}
x = unsafe.Pointer(v)
```

**æŸ¥æ‰¾ç©ºé—² slot çš„ä½å›¾ç®—æ³•**ï¼š

mspan ä½¿ç”¨ `allocBits` ä½å›¾è·Ÿè¸ªæ¯ä¸ª slot çš„åˆ†é…çŠ¶æ€ã€‚æŸ¥æ‰¾ç©ºé—² slot æ—¶ï¼Œåˆ©ç”¨ CPU çš„ `CTZ`ï¼ˆCount Trailing Zerosï¼‰æŒ‡ä»¤ï¼Œå¯ä»¥åœ¨ä¸€æ¡æŒ‡ä»¤å†…æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸º 0 çš„ä½ï¼š

```go
// runtime/mbitmap_allocbits.goï¼ˆç®€åŒ–ï¼‰
func nextFreeFast(s *mspan) (gclinkptr, bool) {
    // allocCache æ˜¯ allocBits çš„æœ¬åœ°ç¼“å­˜ï¼ˆå–ååçš„ï¼‰
    // 1 è¡¨ç¤ºç©ºé—²ï¼Œ0 è¡¨ç¤ºå·²åˆ†é…
    theBit := sys.TrailingZeros64(s.allocCache)
    if theBit < 64 {
        result := s.freeindex + uintptr(theBit)
        if result < s.nelems {
            s.allocCache >>= uint(theBit + 1)
            s.freeindex = result + 1
            // ...
            return gclinkptr(result*s.elemsize + s.base()), true
        }
    }
    return 0, false
}
```

**ä½å›¾ vs ç©ºé—²é“¾è¡¨**ï¼šGo é€‰æ‹©ä½å›¾è€Œé TCMalloc çš„ç©ºé—²é“¾è¡¨ï¼Œæœ‰ä¸¤ä¸ªåŸå› â€”â€”ä½å›¾çš„å†…å­˜è®¿é—®æ›´å±€éƒ¨ï¼ˆå¯¹ CPU ç¼“å­˜å‹å¥½ï¼‰ï¼Œä¸”ä¸éœ€è¦åœ¨å¯¹è±¡å†…éƒ¨å­˜å‚¨é“¾è¡¨æŒ‡é’ˆï¼ˆé¿å… use-after-free ç±»æ”»å‡»ï¼‰ã€‚

### å¤§å¯¹è±¡ï¼ˆ> 32KBï¼‰ï¼šç›´æ¥ä» mheap åˆ†é…

å¤§äº 32KB çš„å¯¹è±¡ä¸èµ° size class æœºåˆ¶ï¼Œè€Œæ˜¯ç›´æ¥å‘ mheap ç”³è¯·æ‰€éœ€æ•°é‡çš„è¿ç»­é¡µï¼š

```go
// runtime/malloc.goï¼ˆç®€åŒ–ï¼‰
// å¤§å¯¹è±¡åˆ†é…è·¯å¾„
span = c.allocLarge(size, noscan)

func (c *mcache) allocLarge(size uintptr, noscan bool) *mspan {
    npages := size >> _PageShift // è®¡ç®—éœ€è¦çš„é¡µæ•°
    if size&_PageMask != 0 {
        npages++
    }
    // ç›´æ¥ä» mheap åˆ†é…ï¼ˆéœ€è¦åŠ é”ï¼‰
    spc := makeSpanClass(0, noscan) // class 0 = å¤§å¯¹è±¡
    s := mheap_.alloc(npages, spc)
    // ...
    return s
}
```

```mermaid
graph LR
    subgraph "ä¸‰ç§åˆ†é…ç­–ç•¥æ€»è§ˆ"
        Tiny["å¾®å¯¹è±¡<br/>< 16B æ— æŒ‡é’ˆ<br/>tiny allocator<br/>åˆå¹¶åˆ° 16B å—"]
        Small["å°å¯¹è±¡<br/>16B ~ 32KB<br/>size class åˆ†é…<br/>mcache â†’ mcentral â†’ mheap"]
        Large["å¤§å¯¹è±¡<br/>> 32KB<br/>ç›´æ¥ä» mheap<br/>åˆ†é…è¿ç»­é¡µ"]
    end

    style Tiny fill:#51cf66
    style Small fill:#ffd43b
    style Large fill:#ff8787
```

| ç±»å‹ | å¤§å°èŒƒå›´ | åˆ†é…è·¯å¾„ | é” | å…¸å‹åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **å¾®å¯¹è±¡** | < 16Bï¼ˆæ— æŒ‡é’ˆï¼‰ | tiny allocator | æ— é” | boolã€byteã€å°æ•´æ•° |
| **å°å¯¹è±¡** | 16B ~ 32KB | mcache â†’ mcentral â†’ mheap | å¤šæ•°æ— é” | structã€stringã€å° slice |
| **å¤§å¯¹è±¡** | > 32KB | mheapï¼ˆç›´æ¥ï¼‰ | å…¨å±€é” | å¤§æ•°ç»„ã€å¤§ slice |

## ä¸ƒã€è™šæ‹Ÿå†…å­˜ä¸é¡µç®¡ç†

### HeapArenaï¼šè™šæ‹Ÿå†…å­˜çš„ç»„ç»‡å•ä½

Go å°†å †å†…å­˜åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ª **heapArena**ã€‚æ¯ä¸ª arena çš„å¤§å°ä¾å¹³å°è€Œå®šï¼š64 ä½é Windows ä¸Šä¸º **64MB**ï¼Œ32 ä½åŠ Windows ä¸Šä¸º **4MB**ï¼š

```mermaid
graph TB
    subgraph "Go å †çš„è™šæ‹Ÿå†…å­˜å¸ƒå±€"
        direction LR
        A0["heapArena 0<br/>64MB"]
        A1["heapArena 1<br/>64MB"]
        Gap1["...ï¼ˆå¯èƒ½ä¸è¿ç»­ï¼‰..."]
        AN["heapArena N<br/>64MB"]
    end

    subgraph "å•ä¸ª heapArena å†…éƒ¨ï¼ˆ64 ä½é Windows: 64MBï¼‰"
        direction TB
        Arena["heapArena (64MB = 8192 é¡µ)"]
        Arena --> Spans["spans [8192]*mspan<br/>æ¯é¡µå¯¹åº”çš„ mspan"]
        Arena --> Bitmap["bitmap<br/>æŒ‡é’ˆ/æ ‡é‡æ ‡è®°"]
        Arena --> PageInUse["pageInUse<br/>é¡µä½¿ç”¨çŠ¶æ€"]
    end

    style A0 fill:#e7f5ff
    style A1 fill:#e7f5ff
    style AN fill:#e7f5ff
```

```go
// runtime/mheap.goï¼ˆç®€åŒ–ï¼‰
type heapArena struct {
    // æ¯é¡µå¯¹åº”å“ªä¸ª mspanï¼ˆç”¨äºä»åœ°å€åæŸ¥ spanï¼‰
    spans [pagesPerArena]*mspan // pagesPerArena = 8192

    // GC ç”¨çš„ä½å›¾ï¼šæ ‡è®°å“ªäº›å­—æ˜¯æŒ‡é’ˆ
    bitmap [heapArenaBitmapWords]uintptr

    // é¡µçš„ä½¿ç”¨çŠ¶æ€
    pageInUse  [pagesPerArena / 8]uint8
    pageMarks  [pagesPerArena / 8]uint8
    // ...
}
```

**ä» Go 1.11 è¯´èµ·**ï¼šåœ¨ Go 1.11 ä¹‹å‰ï¼ŒGo è¦æ±‚å †å ç”¨ä¸€æ®µ**è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´**ï¼ˆåœ¨ Linux amd64 ä¸Šæœ€å¤§ 512GBï¼‰ã€‚è¿™åœ¨æŸäº›åœºæ™¯ä¸‹ä¼šæœ‰é—®é¢˜â€”â€”å¦‚æœè¿™æ®µè¿ç»­ç©ºé—´è¢«å…¶ä»–æ˜ å°„å æ®ï¼ŒGo ç¨‹åºå°±æ— æ³•å¯åŠ¨ã€‚Go 1.11 å¼•å…¥äº†**ç¨€ç–å †**ï¼ˆsparse heapï¼‰ï¼Œarena ä¸å†éœ€è¦è¿ç»­ï¼Œé€šè¿‡ä¸€ä¸ªäºŒçº§æŸ¥æ‰¾è¡¨ï¼ˆ`mheap.arenas`ï¼‰å°†ä»»æ„è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°å¯¹åº”çš„ heapArenaã€‚

### é¡µåˆ†é…å™¨ï¼šé«˜æ•ˆæŸ¥æ‰¾è¿ç»­ç©ºé—²é¡µ

å½“ mheap éœ€è¦åˆ†é… N ä¸ªè¿ç»­é¡µæ—¶ï¼Œå¿…é¡»ä»æ‰€æœ‰ç©ºé—²é¡µä¸­å¿«é€Ÿæ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç©ºé—´ã€‚Go 1.14 å¼•å…¥äº†åŸºäº**åŸºæ•°æ ‘ï¼ˆradix treeï¼‰**çš„é¡µåˆ†é…å™¨ï¼Œæ›¿ä»£äº†ä¹‹å‰è¾ƒæ…¢çš„ treap å®ç°ã€‚

```mermaid
graph TB
    subgraph "åŸºæ•°æ ‘é¡µåˆ†é…å™¨"
        direction TB

        Root["æ ¹èŠ‚ç‚¹<br/>max=8192, start=4096, end=2048"]

        Root --> L1_0["å­èŠ‚ç‚¹ 0<br/>max=4096, start=4096, end=0"]
        Root --> L1_1["å­èŠ‚ç‚¹ 1<br/>max=2048, start=0, end=2048"]

        L1_0 --> L2_0["..."]
        L1_0 --> L2_1["..."]
        L1_1 --> L2_2["..."]
        L1_1 --> L2_3["..."]

        L2_0 --> Leaf["å¶èŠ‚ç‚¹<br/>64 ä½ bitmap<br/>æ¯ä½è¡¨ç¤ºä¸€é¡µ"]
    end

    Note["æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨ä¸‰ä¸ªå€¼ï¼š<br/>start: ä»å¤´éƒ¨å¼€å§‹çš„æœ€å¤§è¿ç»­ç©ºé—²é¡µ<br/>max: ä»»æ„ä½ç½®çš„æœ€å¤§è¿ç»­ç©ºé—²é¡µ<br/>end: ä»å°¾éƒ¨å¼€å§‹çš„æœ€å¤§è¿ç»­ç©ºé—²é¡µ<br/><br/>æŸ¥æ‰¾ N ä¸ªè¿ç»­é¡µï¼š<br/>ä»æ ¹å‘ä¸‹æœç´¢ï¼ŒO(log n) å³å¯æ‰¾åˆ°"]

    style Root fill:#ffd43b
    style L1_0 fill:#e7f5ff
    style L1_1 fill:#e7f5ff
```

æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ª **pallocSum** æ‘˜è¦ï¼Œç¼–ç ä¸‰ä¸ªå€¼ï¼š

- `start`ï¼šä»è¯¥åŒºé—´å¼€å¤´å¼€å§‹çš„æœ€å¤§è¿ç»­ç©ºé—²é¡µæ•°
- `max`ï¼šè¯¥åŒºé—´å†…ä»»æ„ä½ç½®çš„æœ€å¤§è¿ç»­ç©ºé—²é¡µæ•°
- `end`ï¼šä»è¯¥åŒºé—´æœ«å°¾å¼€å§‹çš„æœ€å¤§è¿ç»­ç©ºé—²é¡µæ•°

æŸ¥æ‰¾æ—¶ï¼Œåªéœ€ä»æ ¹èŠ‚ç‚¹å‘ä¸‹éå†ï¼Œæ ¹æ® `max` å­—æ®µåˆ¤æ–­å­æ ‘ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿå¤§çš„è¿ç»­ç©ºé—´ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º **O(log n)**ã€‚è¿™å¯¹å¤§å¯¹è±¡åˆ†é…ï¼ˆéœ€è¦æ•°ç™¾ä¸ªè¿ç»­é¡µï¼‰çš„æ€§èƒ½è‡³å…³é‡è¦ã€‚

### å†…å­˜å½’è¿˜ï¼šscavenger

Go å¹¶ä¸ä¼šç«‹å³å°†ç©ºé—²å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯ç”±ä¸€ä¸ªåå°çš„ **scavenger**ï¼ˆæ‹¾è’è€…ï¼‰Goroutine å‘¨æœŸæ€§åœ°å°†ä¸å†ä½¿ç”¨çš„é¡µæ ‡è®°ä¸º `MADV_DONTNEED`ï¼ˆLinuxï¼‰æˆ–ç­‰ä»·æ“ä½œï¼š

```go
// ä¸æ˜¯çœŸæ­£é‡Šæ”¾è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè€Œæ˜¯å‘Šè¯‰ OSï¼š
// "è¿™äº›é¡µæš‚æ—¶ä¸ç”¨äº†ï¼Œç‰©ç†å†…å­˜å¯ä»¥å›æ”¶"
// å¦‚æœä¸‹æ¬¡å†è®¿é—®ï¼ŒOS ä¼šé‡æ–°åˆ†é…é›¶é¡µ
madvise(addr, size, _MADV_DONTNEED)
```

è¿™æ„å‘³ç€ Go ç¨‹åºçš„**è™šæ‹Ÿå†…å­˜ï¼ˆVSZï¼‰å¯èƒ½å¾ˆå¤§**ï¼Œä½†**ç‰©ç†å†…å­˜ï¼ˆRSSï¼‰**ä¼šéšç€ scavenger çš„å·¥ä½œé€æ¸å›è½ã€‚åœ¨å®¹å™¨æˆ–å†…å­˜å—é™çš„ç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡ `GOMEMLIMIT`ï¼ˆGo 1.19+ï¼‰è®¾ç½®è½¯å†…å­˜ä¸Šé™ã€‚

## å…«ã€æ ˆåˆ†é…ä¸é€ƒé€¸åˆ†æ

### æ ˆåˆ†é…ï¼šæœ€ç†æƒ³çš„æƒ…å†µ

å‰é¢è®¨è®ºçš„éƒ½æ˜¯**å †**åˆ†é…ã€‚ä½†å®é™…ä¸Šï¼ŒGo ç¼–è¯‘å™¨ä¼šå°½é‡å°†å¯¹è±¡åˆ†é…åœ¨ Goroutine çš„**æ ˆ**ä¸Šâ€”â€”æ ˆåˆ†é…åªéœ€è¦ç§»åŠ¨æ ˆæŒ‡é’ˆï¼Œæˆæœ¬å‡ ä¹ä¸ºé›¶ï¼Œè€Œä¸”å¯¹è±¡éšå‡½æ•°è¿”å›è‡ªåŠ¨é‡Šæ”¾ï¼Œå®Œå…¨ä¸éœ€è¦ GC å‚ä¸ã€‚

| ç»´åº¦ | æ ˆåˆ†é… | å †åˆ†é… |
| --- | --- | --- |
| **é€Ÿåº¦** | ç§»åŠ¨ SP æŒ‡é’ˆï¼Œçº³ç§’çº§ | mallocgc æµç¨‹ï¼Œæ•°åçº³ç§’ |
| **GC å‹åŠ›** | é›¶ï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰ | éœ€è¦ GC è¿½è¸ªå’Œå›æ”¶ |
| **ç”Ÿå‘½å‘¨æœŸ** | å‡½æ•°è¿”å›å³é‡Šæ”¾ | GC ç¡®è®¤ä¸å¯è¾¾åé‡Šæ”¾ |
| **ç¢ç‰‡** | æ—  | å–å†³äºåˆ†é…å™¨ |

### é€ƒé€¸åˆ†æï¼šç¼–è¯‘å™¨çš„å…³é”®å†³ç­–

**é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰** æ˜¯ Go ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸè¿›è¡Œçš„ä¸€é¡¹åˆ†æâ€”â€”åˆ¤æ–­ä¸€ä¸ªå˜é‡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯å¦è¶…å‡ºäº†å£°æ˜å®ƒçš„å‡½æ•°ã€‚å¦‚æœ**æ²¡æœ‰é€ƒé€¸**ï¼Œå¯ä»¥å®‰å…¨åœ°åˆ†é…åœ¨æ ˆä¸Šï¼›å¦‚æœ**é€ƒé€¸äº†**ï¼Œå¿…é¡»åˆ†é…åœ¨å †ä¸Šã€‚

```mermaid
graph TB
    Var["å˜é‡ v"] --> Check{"ç¼–è¯‘å™¨é€ƒé€¸åˆ†æ"}

    Check -->|"v æœªé€ƒé€¸<br/>ç”Ÿå‘½å‘¨æœŸåœ¨å‡½æ•°å†…"| Stack["åˆ†é…åœ¨æ ˆä¸Š âœ“<br/>é›¶ GC å¼€é”€"]
    Check -->|"v é€ƒé€¸äº†<br/>å¯èƒ½è¢«å¤–éƒ¨å¼•ç”¨"| Heap["åˆ†é…åœ¨å †ä¸Š<br/>mallocgc â†’ GC ç®¡ç†"]

    style Stack fill:#51cf66
    style Heap fill:#ff8787
```

### å¸¸è§çš„é€ƒé€¸åœºæ™¯

**åœºæ™¯ 1ï¼šè¿”å›å±€éƒ¨å˜é‡çš„æŒ‡é’ˆ**

```go
func newUser() *User {
    u := User{Name: "Alice"} // u é€ƒé€¸åˆ°å †ä¸Š
    return &u                 // è¿”å›äº†æŒ‡å‘ u çš„æŒ‡é’ˆ
}
```

å‡½æ•°è¿”å›åæ ˆå¸§è¢«å›æ”¶ï¼Œä½†è¿”å›çš„æŒ‡é’ˆä»ç„¶æŒ‡å‘ `u`â€”â€”å› æ­¤ `u` å¿…é¡»åˆ†é…åœ¨å †ä¸Šã€‚

**åœºæ™¯ 2ï¼šèµ‹å€¼ç»™æ¥å£ç±»å‹**

```go
func print(val interface{}) { ... }

func main() {
    x := 42
    print(x) // x é€ƒé€¸ï¼šinterface{} åº•å±‚å¯èƒ½éœ€è¦å †ä¸Šåˆ†é…
}
```

æ¥å£çš„å†…éƒ¨è¡¨ç¤ºï¼ˆ`eface`/`iface`ï¼‰éœ€è¦å­˜å‚¨å€¼çš„æŒ‡é’ˆã€‚å¯¹äºè¾ƒå¤§çš„å€¼ç±»å‹æˆ–ç¼–è¯‘å™¨æ— æ³•å†…è”ä¼˜åŒ–çš„æƒ…å†µï¼Œå€¼ä¼šé€ƒé€¸åˆ°å †ä¸Šã€‚

**åœºæ™¯ 3ï¼šé—­åŒ…å¼•ç”¨å±€éƒ¨å˜é‡**

```go
func counter() func() int {
    n := 0
    return func() int { // é—­åŒ…æ•è·äº† n
        n++              // n é€ƒé€¸ï¼šé—­åŒ…å¯èƒ½åœ¨å‡½æ•°è¿”å›åä½¿ç”¨ n
        return n
    }
}
```

**åœºæ™¯ 4ï¼šå‘é€åˆ° channel**

```go
func producer(ch chan<- *Data) {
    d := &Data{Value: 1} // d é€ƒé€¸ï¼šé€šè¿‡ channel ä¼ é€’
    ch <- d
}
```

**åœºæ™¯ 5ï¼šslice/map çš„åŠ¨æ€å¢é•¿**

```go
func growSlice() {
    s := make([]int, 0)
    for i := 0; i < 100; i++ {
        s = append(s, i) // åº•å±‚æ•°ç»„å¯èƒ½é€ƒé€¸ï¼ˆç¼–è¯‘å™¨æ— æ³•ç¡®å®šæœ€ç»ˆå¤§å°ï¼‰
    }
}
```

**åœºæ™¯ 6ï¼šfmt.Println ç­‰å˜å‚å‡½æ•°**

```go
func main() {
    x := 42
    fmt.Println(x) // x é€ƒé€¸ï¼šPrintln æ¥æ”¶ ...interface{} å‚æ•°
}
```

### é€ƒé€¸åˆ†æå®æˆ˜ï¼šgcflags

ä½¿ç”¨ `-gcflags="-m"` å¯ä»¥è®©ç¼–è¯‘å™¨è¾“å‡ºé€ƒé€¸åˆ†æç»“æœï¼š

```bash
# -m  è¾“å‡ºé€ƒé€¸åˆ†æä¿¡æ¯
# -l  ç¦ç”¨å†…è”ï¼ˆè®©ç»“æœæ›´æ¸…æ™°ï¼‰
go build -gcflags="-m -l" main.go
```

**ç¤ºä¾‹ä»£ç **ï¼š

```go
package main

import "fmt"

type User struct {
    Name string
    Age  int
}

func newUser(name string, age int) *User {
    u := &User{Name: name, Age: age}
    return u
}

func printUser(u User) {
    fmt.Println(u.Name)
}

func main() {
    u := newUser("Alice", 30)
    printUser(*u)

    v := User{Name: "Bob", Age: 25}
    printUser(v)
}
```

**ç¼–è¯‘å™¨è¾“å‡º**ï¼š

```
./main.go:11:6: &User{...} escapes to heap        â† newUser è¿”å›äº†æŒ‡é’ˆï¼Œu é€ƒé€¸
./main.go:15:13: ... argument does not escape      â† ä½†ä¹Ÿå¯èƒ½é€ƒé€¸ï¼ˆå–å†³äºå†…è”ï¼‰
./main.go:15:16: u.Name escapes to heap            â† fmt.Println çš„ interface{} å‚æ•°
./main.go:22:12: v does not escape                 â† v æ˜¯å€¼ä¼ é€’ï¼Œä¸é€ƒé€¸
```

åŠ  `-m -m`ï¼ˆä¸¤ä¸ª `-m`ï¼‰å¯ä»¥è·å¾—æ›´è¯¦ç»†çš„åˆ†æåŸå› ï¼š

```bash
go build -gcflags="-m -m -l" main.go
```

```
./main.go:11:6: &User{...} escapes to heap:
./main.go:11:6:   flow: u = &{storage for &User{...}}:
./main.go:11:6:     from &User{...} (spill) at ./main.go:11:6
./main.go:11:6:     from u := &User{...} (assign) at ./main.go:11:4
./main.go:11:6:   flow: ~r0 = u:
./main.go:11:6:     from return u (return) at ./main.go:12:2
```

### å‡å°‘é€ƒé€¸çš„å®ç”¨æŠ€å·§

| æŠ€å·§ | è¯´æ˜ | ç¤ºä¾‹ |
| --- | --- | --- |
| **è¿”å›å€¼è€ŒéæŒ‡é’ˆ** | å¦‚æœç»“æ„ä½“ä¸å¤§ï¼Œè¿”å›å€¼æ‹·è´æ¯”å †åˆ†é…æ›´é«˜æ•ˆ | `return User{...}` |
| **é¢„åˆ†é… slice** | ç¼–è¯‘å™¨ç¡®å®šå¤§å°æ—¶å¯ä»¥æ ˆåˆ†é… | `make([]int, 0, 10)` |
| **é¿å… interface{} å‚æ•°** | å…·ä½“ç±»å‹å‚æ•°ä¸ä¼šå› æ¥å£è½¬æ¢é€ƒé€¸ | ç”¨ `string` æ›¿ä»£ `any` |
| **å°å¿ƒ fmt.Println** | çƒ­è·¯å¾„ä¸­ç”¨ `log` æˆ–ç›´æ¥å†™ writer | é¿å…åœ¨å¾ªç¯ä¸­è°ƒç”¨ |
| **åˆç†ä½¿ç”¨å€¼æ¥æ”¶è€…** | å€¼æ¥æ”¶è€…æ–¹æ³•è°ƒç”¨ä¸éœ€è¦å–åœ°å€ | `func (u User) String()` |

## ä¹ã€å®æˆ˜ï¼šå†…å­˜ä¼˜åŒ–æŠ€å·§

### sync.Poolï¼šä¸´æ—¶å¯¹è±¡å¤ç”¨

`sync.Pool` æ˜¯æ ‡å‡†åº“æä¾›çš„å¯¹è±¡æ± ï¼Œå¯ä»¥å¤ç”¨ä¸´æ—¶å¯¹è±¡ï¼Œå‡å°‘å †åˆ†é…å’Œ GC å‹åŠ›ï¼š

```go
var bufPool = sync.Pool{
    New: func() interface{} {
        return new(bytes.Buffer)
    },
}

func handleRequest(data []byte) {
    buf := bufPool.Get().(*bytes.Buffer) // ä»æ± ä¸­è·å–
    buf.Reset()
    defer bufPool.Put(buf) // ç”¨å®Œå½’è¿˜

    buf.Write(data)
    // ä½¿ç”¨ buf...
}
```

**sync.Pool çš„å†…éƒ¨æœºåˆ¶**ä¸å†…å­˜åˆ†é…å™¨æ·±åº¦é›†æˆï¼š

```mermaid
graph TB
    subgraph "sync.Pool çš„å†…éƒ¨ç»“æ„"
        direction TB

        subgraph PerP["æ¯ä¸ª P çš„æœ¬åœ°æ± "]
            Private["privateï¼ˆå•å…ƒç´ å¿«å–ï¼‰"]
            Shared["sharedï¼ˆé“¾è¡¨ï¼‰"]
        end

        Victim["victim cache<br/>ï¼ˆä¸Šä¸€è½® GC çš„æ®‹ç•™ï¼‰"]
    end

    Get["pool.Get()"] -->|"1. æ£€æŸ¥ private"| Private
    Private -->|"ç©º"| Shared
    Shared -->|"ç©º"| Steal["å·å…¶ä»– P çš„ shared"]
    Steal -->|"ç©º"| Victim
    Victim -->|"ç©º"| New["è°ƒç”¨ pool.New()"]

    style Private fill:#51cf66
    style Shared fill:#ffd43b
    style Victim fill:#e7f5ff
```

**æ³¨æ„**ï¼šsync.Pool ä¸­çš„å¯¹è±¡åœ¨æ¯æ¬¡ GC æ—¶å¯èƒ½è¢«æ¸…ç†ï¼ˆç§»å…¥ victim cacheï¼Œå†ä¸‹ä¸€æ¬¡ GC æ‰çœŸæ­£ä¸¢å¼ƒï¼‰ã€‚å®ƒé€‚åˆ**ä¸´æ—¶å¯¹è±¡**çš„å¤ç”¨ï¼Œä¸é€‚åˆåšé•¿æœŸçš„å¯¹è±¡ç¼“å­˜ã€‚

### slice é¢„åˆ†é…

```go
// âŒ ä¸é¢„åˆ†é…ï¼šå¤šæ¬¡æ‰©å®¹ï¼Œæ¯æ¬¡å¯èƒ½è§¦å‘å †åˆ†é…
func bad() []int {
    var s []int
    for i := 0; i < 10000; i++ {
        s = append(s, i) // å¤šæ¬¡æ‰©å®¹ï¼Œå¤šæ¬¡åˆ†é…
    }
    return s
}

// âœ“ é¢„åˆ†é…ï¼šä¸€æ¬¡åˆ†é…åˆ°ä½
func good() []int {
    s := make([]int, 0, 10000) // ä¸€æ¬¡åˆ†é… 10000 ä¸ªå…ƒç´ çš„ç©ºé—´
    for i := 0; i < 10000; i++ {
        s = append(s, i) // ä¸å†è§¦å‘æ‰©å®¹
    }
    return s
}
```

é¢„åˆ†é…å¯ä»¥å°† N æ¬¡åˆ†é…å‡å°‘ä¸º 1 æ¬¡ï¼Œåœ¨å¾ªç¯ä¸­å°¤ä¸ºé‡è¦ã€‚

### å­—ç¬¦ä¸²æ‹¼æ¥ä¼˜åŒ–

```go
// âŒ å¾ªç¯ä¸­ç”¨ + æ‹¼æ¥ï¼šæ¯æ¬¡æ‹¼æ¥éƒ½äº§ç”Ÿæ–°å­—ç¬¦ä¸²ï¼ˆå †åˆ†é…ï¼‰
func bad() string {
    s := ""
    for i := 0; i < 1000; i++ {
        s += strconv.Itoa(i) // 1000 æ¬¡å †åˆ†é…
    }
    return s
}

// âœ“ ä½¿ç”¨ strings.Builderï¼šåº•å±‚ []byte æŒ‰éœ€å¢é•¿
func good() string {
    var b strings.Builder
    b.Grow(4000) // é¢„ä¼°å¤§å°ï¼Œå‡å°‘æ‰©å®¹
    for i := 0; i < 1000; i++ {
        b.WriteString(strconv.Itoa(i))
    }
    return b.String()
}
```

### ç”¨ pprof å®šä½å†…å­˜é—®é¢˜

Go å†…ç½®çš„ `pprof` å·¥å…·å¯ä»¥è¯¦ç»†å±•ç¤ºå†…å­˜åˆ†é…æƒ…å†µï¼š

```go
import _ "net/http/pprof"

func main() {
    go func() {
        http.ListenAndServe("localhost:6060", nil)
    }()
    // ...
}
```

```bash
# æŸ¥çœ‹å½“å‰å †å†…å­˜ï¼ˆinuse_space: æ­£åœ¨ä½¿ç”¨çš„å†…å­˜ï¼‰
go tool pprof http://localhost:6060/debug/pprof/heap

# æŸ¥çœ‹ç´¯è®¡åˆ†é…é‡ï¼ˆalloc_space: æ€»å…±åˆ†é…è¿‡çš„å†…å­˜ï¼‰
go tool pprof -alloc_space http://localhost:6060/debug/pprof/heap

# åœ¨ pprof äº¤äº’ç•Œé¢ä¸­ï¼š
(pprof) top 10         # æŸ¥çœ‹åˆ†é…æœ€å¤šçš„å‡½æ•°
(pprof) list funcName  # æŸ¥çœ‹æŸå‡½æ•°çš„é€è¡Œåˆ†é…
(pprof) web            # ç”Ÿæˆå¯è§†åŒ–å›¾ï¼ˆéœ€è¦ graphvizï¼‰
```

**å…³é”®æŒ‡æ ‡**ï¼š

- `inuse_space`ï¼šå½“å‰å †ä¸Šæ­£åœ¨ä½¿ç”¨çš„å†…å­˜é‡â€”â€”åæ˜ å®é™…å†…å­˜å ç”¨
- `inuse_objects`ï¼šå½“å‰å †ä¸Šæ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡æ•°é‡
- `alloc_space`ï¼šç¨‹åºå¯åŠ¨ä»¥æ¥çš„ç´¯è®¡åˆ†é…é‡â€”â€”åæ˜ åˆ†é…å‹åŠ›
- `alloc_objects`ï¼šç´¯è®¡åˆ†é…å¯¹è±¡æ•°

`alloc_space` é«˜ä½† `inuse_space` ä½ï¼Œè¯´æ˜å¯¹è±¡åˆ†é…é¢‘ç¹ä½†ç”Ÿå‘½å‘¨æœŸçŸ­â€”â€”è¿™æ­£æ˜¯ sync.Pool å’Œå‡å°‘é€ƒé€¸èƒ½ä¼˜åŒ–çš„åœºæ™¯ã€‚

## åã€æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥è¡¨

| æ¦‚å¿µ | å«ä¹‰ | å…³é”®ç‰¹å¾ |
| --- | --- | --- |
| **mspan** | è¿ç»­é¡µç»„æˆçš„å†…å­˜å—ï¼Œåˆ’åˆ†ä¸ºç­‰å¤§ slot | å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼Œä½å›¾è¿½è¸ªåˆ†é…çŠ¶æ€ |
| **mcache** | æ¯ä¸ª P æŒæœ‰çš„æœ¬åœ°ç¼“å­˜ | æ— é”åˆ†é…ï¼Œ136 ä¸ªæ´»è·ƒ mspan |
| **mcentral** | æ¯ç§ span class çš„ä¸­å¿ƒç¼“å­˜ | ç»†ç²’åº¦é”ï¼Œè¿æ¥ mcache ä¸ mheap |
| **mheap** | å…¨å±€å †ç®¡ç†å™¨ | å…¨å±€é”ï¼Œé¡µåˆ†é…å™¨ + arena ç®¡ç† |
| **size class** | 68 ç§é¢„å®šä¹‰å¯¹è±¡å¤§å°è§„æ ¼ | 8B\~32KBï¼Œé—´éš”çº¦ 12.5%ï¼Œå‡å°‘ç¢ç‰‡ |
| **span class** | size class Ã— {scan, noscan} = 136 ç§ | åŒºåˆ†æŒ‡é’ˆå¯¹è±¡ï¼Œå¸®åŠ© GC ä¼˜åŒ– |
| **tiny allocator** | å¾®å¯¹è±¡åˆå¹¶åˆ†é…å™¨ | <16B æ— æŒ‡é’ˆå¯¹è±¡æ‰“åŒ…è¿› 16B å— |
| **é€ƒé€¸åˆ†æ** | ç¼–è¯‘å™¨å†³å®šå˜é‡åˆ†é…åœ¨æ ˆè¿˜æ˜¯å † | å‡å°‘å †åˆ†é… = å‡å°‘ GC å‹åŠ› |

### åˆ†é…å™¨çš„è®¾è®¡å“²å­¦

1. **åˆ†å±‚ç¼“å­˜ï¼Œé€çº§åŠ é”**ï¼šmcacheï¼ˆæ— é”ï¼‰â†’ mcentralï¼ˆç»†ç²’åº¦é”ï¼‰â†’ mheapï¼ˆå…¨å±€é”ï¼‰ï¼Œ85% ä»¥ä¸Šçš„åˆ†é…åœ¨ç¬¬ä¸€å±‚å®Œæˆ
2. **ä¸è°ƒåº¦å™¨é›†æˆ**ï¼šmcache ç»‘å®š P è€Œé Mï¼Œä¸ GMP è°ƒåº¦å™¨çš„ Hand-off æœºåˆ¶å®Œç¾é…åˆ
3. **ä¸ GC åä½œ**ï¼šscan/noscan åˆ†ç±»ã€allocBits/gcmarkBits çš„è®¾è®¡è®©åˆ†é…å™¨å’Œ GC å…±äº«æ•°æ®ç»“æ„ï¼Œå‡å°‘é¢å¤–å¼€é”€
4. **å‡å°‘ç¢ç‰‡**ï¼šsize class å°†å†…éƒ¨ç¢ç‰‡æ§åˆ¶åœ¨ 12.5% ä»¥å†…ï¼Œä½å›¾åˆ†é…æ¶ˆé™¤å¤–éƒ¨ç¢ç‰‡
5. **æ ˆä¼˜å…ˆ**ï¼šç¼–è¯‘å™¨é€ƒé€¸åˆ†æå°½é‡è®©å¯¹è±¡ç•™åœ¨æ ˆä¸Šï¼Œä»æºå¤´å‡å°‘å †åˆ†é…

### å¸¸è§é¢è¯•é—®é¢˜

**Qï¼šGo çš„å†…å­˜åˆ†é…å™¨å€Ÿé‰´äº†ä»€ä¹ˆæ€æƒ³ï¼Ÿä¸ TCMalloc æœ‰ä½•ä¸åŒï¼Ÿ**

å€Ÿé‰´äº† TCMalloc çš„åˆ†å±‚ç¼“å­˜å’Œ size class æ€æƒ³ã€‚ä¸»è¦ä¸åŒç‚¹ï¼šmcache ç»‘å®š P è€Œéçº¿ç¨‹ï¼ˆæ›´é€‚åˆ Goroutine æ¨¡å‹ï¼‰ï¼›ä½¿ç”¨ä½å›¾è€Œéç©ºé—²é“¾è¡¨ç®¡ç† slotï¼›ä¸ GC æ·±åº¦é›†æˆï¼ˆscan/noscan åˆ†ç±»ã€æ ‡è®°ä½å›¾å…±äº«ï¼‰ï¼›å¢åŠ äº† tiny allocator ä¼˜åŒ–å¾®å°å¯¹è±¡ã€‚

**Qï¼šä¸€æ¬¡å°å¯¹è±¡åˆ†é…æœ€å°‘å’Œæœ€å¤šéœ€è¦èµ°å‡ æ­¥ï¼Ÿ**

æœ€å°‘ä¸€æ­¥ï¼šmcache ä¸­å¯¹åº” span class çš„ mspan æœ‰ç©ºé—² slotï¼Œç›´æ¥åˆ†é…ï¼ˆæ— é”ï¼‰ã€‚æœ€å¤šå››æ­¥ï¼šmcache æ— å¯ç”¨ slot â†’ mcentral æ— å¯ç”¨ mspan â†’ mheap æ— ç©ºé—²é¡µ â†’ å‘ OS ç”³è¯·æ–°å†…å­˜ï¼ˆmmapï¼‰ã€‚

**Qï¼šä»€ä¹ˆæ˜¯é€ƒé€¸åˆ†æï¼Ÿä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ**

é€ƒé€¸åˆ†ææ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸåˆ¤æ–­å˜é‡ç”Ÿå‘½å‘¨æœŸæ˜¯å¦è¶…å‡ºå½“å‰å‡½æ•°çš„åˆ†æè¿‡ç¨‹ã€‚å˜é‡ä¸é€ƒé€¸å¯ä»¥æ ˆåˆ†é…â€”â€”é€Ÿåº¦å¿«ã€æ—  GC å¼€é”€ã€è‡ªåŠ¨é‡Šæ”¾ã€‚å‡å°‘é€ƒé€¸å°±æ˜¯å‡å°‘å †åˆ†é…ï¼Œç›´æ¥é™ä½ GC å‹åŠ›ï¼Œæ˜¯ Go æ€§èƒ½ä¼˜åŒ–çš„é‡è¦æ‰‹æ®µã€‚

**Qï¼šä¸ºä»€ä¹ˆ Go ç¨‹åºçš„è™šæ‹Ÿå†…å­˜ï¼ˆVSZï¼‰çœ‹èµ·æ¥å¾ˆå¤§ï¼Ÿ**

Go ä½¿ç”¨ `mmap` é¢„ç•™è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆarenaï¼‰ï¼Œä½†ä¸ä¸€å®šç«‹å³ä½¿ç”¨ç‰©ç†å†…å­˜ã€‚è™šæ‹Ÿåœ°å€ç©ºé—´çš„é¢„ç•™æ˜¯"å…è´¹"çš„ï¼ˆä¸å ç”¨å®é™… RAMï¼‰ï¼Œåªæœ‰çœŸæ­£å†™å…¥æ—¶æ‰ä¼šåˆ†é…ç‰©ç†é¡µã€‚å…³æ³¨ RSSï¼ˆå¸¸é©»å†…å­˜ï¼‰æ¯” VSZ æ›´æœ‰æ„ä¹‰ã€‚scavenger ä¼šå‘¨æœŸæ€§åœ°å°†ä¸å†ä½¿ç”¨çš„ç‰©ç†é¡µå½’è¿˜ç»™ OSã€‚

**Qï¼šsync.Pool æ˜¯å¦‚ä½•å‡å°‘å†…å­˜åˆ†é…çš„ï¼Ÿ**

sync.Pool ä¸ºæ¯ä¸ª P ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°æ± ï¼ˆprivate + sharedï¼‰ï¼Œè·å–å¯¹è±¡æ—¶ä¼˜å…ˆä»æœ¬åœ°æ± å–ï¼ˆæ— é”ï¼‰ï¼Œæ± ç©ºæ—¶æ‰çœŸæ­£åˆ†é…æ–°å¯¹è±¡ã€‚å½’è¿˜çš„å¯¹è±¡å¯ä»¥è¢«åç»­è¯·æ±‚å¤ç”¨ï¼Œé¿å…é‡å¤çš„å †åˆ†é…å’Œ GC å›æ”¶ã€‚ä½† Pool ä¸­çš„å¯¹è±¡ä¼šåœ¨ GC æ—¶è¢«æ¸…ç†ï¼Œå› æ­¤åªé€‚åˆä¸´æ—¶å¯¹è±¡çš„ç¼“å­˜ã€‚

---

ç†è§£ Go çš„å†…å­˜åˆ†é…å™¨ï¼Œæ˜¯æ·±å…¥ç†è§£ Go è¿è¡Œæ—¶çš„å…³é”®ä¸€æ­¥ã€‚å½“ä½ çŸ¥é“ `new(T)` èƒŒåç»å†äº†æ€æ ·çš„æ—…ç¨‹â€”â€”ä» mcache çš„æ— é”å¿«é€Ÿè·¯å¾„ï¼Œåˆ° mcentral çš„ç»†ç²’åº¦åè°ƒï¼Œå†åˆ° mheap çš„é¡µçº§ç®¡ç†â€”â€”é‚£äº›å…³äºå†…å­˜ä¼˜åŒ–ã€GC è°ƒä¼˜ã€æ€§èƒ½è¯Šæ–­çš„é—®é¢˜ï¼Œå°±éƒ½æœ‰äº†æ¸…æ™°çš„ç­”æ¡ˆã€‚è€ŒæŒæ¡é€ƒé€¸åˆ†æï¼Œè®©ä½ èƒ½åœ¨**å†™ä»£ç çš„æ—¶å€™**å°±åšå‡ºæ›´ä¼˜çš„å†³ç­–ï¼šèƒ½ç”¨å€¼å°±ä¸ç”¨æŒ‡é’ˆï¼Œèƒ½é¢„åˆ†é…å°±ä¸è¦åŠ¨æ€å¢é•¿ï¼Œèƒ½é¿å… `interface{}` å°±ç”¨å…·ä½“ç±»å‹ã€‚
